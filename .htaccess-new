RewriteEngine On

# Handle CORS for all requests
Header always set Access-Control-Allow-Origin "*"
Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"

# Handle CORS preflight requests
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ - [R=200,L]

# Route API requests to the api directory (don't touch these)
RewriteRule ^api/(.*)$ api/$1 [L]

# Serve static files directly if they exist in dist directory
RewriteCond %{DOCUMENT_ROOT}/dist/$1 -f
RewriteRule ^(.*)$ dist/$1 [L]

# For everything else that's not an API call and not a real file, serve React app
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ dist/index.html [L]

# Set proper MIME types for static assets
<FilesMatch "\.(css|js|json|svg|png|jpg|jpeg|gif|ico|woff|woff2|ttf|eot)$">
    Header set Cache-Control "public, max-age=31536000"
</FilesMatch>

# Ensure HTML files are not cached
<FilesMatch "\.html$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
</FilesMatch>
